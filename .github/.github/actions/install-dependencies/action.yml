name: Install dependencies
description: 'Installs and caches Node.js dependencies using Yarn.'

runs:
  using: 'composite'
  steps:
    - uses: ./.github/.github/actions/lock-nodejs-ver

    - name: Restore node_modules from cache
      uses: actions/cache/restore@v3
      id: restore_node_modules
      with:
        key: ${{ runner.os }}-yarn-${{ hashFiles('${{ github.workspace }}/yarn.lock') }}
        restore-keys: ${{ runner.os }}-yarn-
        path: ${{ github.workspace }}/node_modules


    - name: Install node_modules
      if: steps.restore_node_modules.outputs.cache-hit != 'true'
      shell: bash
      run: |
        # Retry 3 times before the steps actually fails
        (echo "===== Install node_modules Attempt:  1 ====" && yarn install --frozen-lockfile) || \
        (echo "===== Install node_modules Attempt:  2 ====" && yarn install --frozen-lockfile) || \
        (echo "===== Install node_modules Attempt:  3 ====" && yarn install --frozen-lockfile) || \
        (echo "===== Install node_modules Step Failed ====" && exit 1)


    - name: Save node_modules to cache
      if: steps.restore_node_modules.outputs.cache-hit != 'true'
      uses: actions/cache/save@v3
      with:
        key: ${{ steps.restore_node_modules.outputs.cache-primary-key }}
        path: ${{ github.workspace }}/node_modules
